<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>SSE ì•Œë¦¼ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        #sse-url {
            margin-bottom: 20px;
            font-weight: bold;
            color: #555;
        }
        #messages p {
            padding: 5px;
            margin: 0;
            border-bottom: 1px solid #ccc;
        }
    </style>
</head>
<body>
<h2>ğŸ“¢ ì•Œë¦¼ ë©”ì‹œì§€</h2>
<div id="sse-url"></div>
<div id="messages"></div>
<script>
    const HOST = window.HOST || 'http://localhost:8080';

    const token = localStorage.getItem('accessToken');
    if (!token) {
        alert('í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ì ‘ì†í•˜ì„¸ìš”.');
        throw new Error('No token');
    }

    let payload;
    try {
        payload = JSON.parse(atob(token.split('.')[1]));
    } catch (e) {
        alert('í† í° íŒŒì‹± ì˜¤ë¥˜');
        throw e;
    }

    const userId = payload.userId || payload.id;
    if (!userId) {
        alert('í† í°ì— userId ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        throw new Error('userId ì—†ìŒ');
    }

    const messages = document.getElementById('messages');
    const sseUrlDiv = document.getElementById('sse-url');

    const sseUrl = `${HOST}/api/notification/subscribe?token=${token}`;
    sseUrlDiv.textContent = `SSE ì—°ê²° URL: ${sseUrl}`;

    const token = localStorage.getItem('accessToken');

    if (!token) {
        alert('í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ì ‘ì†í•˜ì„¸ìš”.');
        throw new Error('No token');
    }

    let payload;
    try {
        payload = JSON.parse(atob(token.split('.')[1]));
    } catch (e) {
        alert('í† í° íŒŒì‹± ì˜¤ë¥˜');
        throw e;
    }

    const userId = payload.userId || payload.id;
    if (!userId) {
        alert('í† í°ì— userId ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        throw new Error('userId ì—†ìŒ');
    }

    const messages = document.getElementById('messages');
    const sseUrlDiv = document.getElementById('sse-url');

    const sseUrl = `http://localhost:8080/api/notification/subscribe?token=${token}`;
    sseUrlDiv.textContent = `SSE ì—°ê²° URL: ${sseUrl}`;

    function loadUnreadNotifications() {
        fetch(`http://localhost:8080/api/notification/unread`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(res => {
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            messages.innerHTML = '';
            if (!data || data.length === 0) {
                messages.innerHTML = '<p><i>ì½ì§€ ì•Šì€ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</i></p>';
            } else {
                data.forEach(notification => {
                    const p = document.createElement('p');
                    p.textContent = `[${notification.type}] ${notification.content}`;
                    messages.appendChild(p);
                });
            }
        })
        .catch(err => {
            console.error('ì•ˆì½ì€ ì•Œë¦¼ ì¡°íšŒ ì‹¤íŒ¨:', err);
            messages.innerHTML = '<p><i>ì•Œë¦¼ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</i></p>';
        });
    }

    function connectSse() {
        const eventSource = new EventSource(sseUrl);

        eventSource.onopen = () => console.log('SSE ì—°ê²° ì„±ê³µ');

        eventSource.addEventListener("sse", function(event) {
            try {
                const data = JSON.parse(event.data);
                const p = document.createElement('p');
                p.textContent = `[${data.type}] ${data.content}`;
                messages.appendChild(p);
            } catch (e) {
                console.error('SSE ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', event.data);
            }
        });

        eventSource.onerror = function(err) {
            console.error('SSE ì—°ê²° ì˜¤ë¥˜:', err);
            eventSource.close();
            setTimeout(() => {
                console.log('SSE ì¬ì—°ê²° ì‹œë„...');
                connectSse();
            }, 5000);
        };
    }

    loadUnreadNotifications();
    connectSse();
</script>

</body>
</html>
