<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>SSE ì•Œë¦¼ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        #sse-url {
            margin-bottom: 20px;
            font-weight: bold;
            color: #555;
        }
        #messages p {
            padding: 5px;
            margin: 0;
            border-bottom: 1px solid #ccc;
        }
    </style>
</head>
<body>
<h2>ğŸ“¢ ì•Œë¦¼ ë©”ì‹œì§€</h2>
<div id="sse-url"></div>
<div id="messages"></div>

<script>
    const token = localStorage.getItem('accessToken');

    if (!token) {
        alert('í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ì ‘ì†í•˜ì„¸ìš”.');
        throw new Error('No token');
    }

    // JWT payload ì¶”ì¶œ
    let payload;
    try {
        payload = JSON.parse(atob(token.split('.')[1]));
    } catch (e) {
        alert('í† í° íŒŒì‹± ì˜¤ë¥˜');
        throw e;
    }

    // í† í° ë‚´ userId í•„ë“œëª… í™•ì¸ (userId ë˜ëŠ” id)
    const userId = payload.userId || payload.id;
    if (!userId) {
        alert('í† í°ì— userId ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        throw new Error('userId ì—†ìŒ');
    }

    const messages = document.getElementById('messages');
    const sseUrlDiv = document.getElementById('sse-url');

    // SSE êµ¬ë… URL í‘œì‹œ (í† í° í¬í•¨)
    const sseUrl = `http://localhost:8080/notification/subscribe?token=${token}`;
    sseUrlDiv.textContent = `SSE ì—°ê²° URL: ${sseUrl}`;

    // ê¸°ì¡´ ì•ˆì½ì€ ì•Œë¦¼ ì¡°íšŒ ë° ì¶œë ¥
    function loadUnreadNotifications() {
        fetch(`http://localhost:8080/notification/unread?userId=${userId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(res => {
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            messages.innerHTML = '';
            if (!data || data.length === 0) {
                messages.innerHTML = '<p><i>ì½ì§€ ì•Šì€ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</i></p>';
            } else {
                data.forEach(notification => {
                    const p = document.createElement('p');
                    p.textContent = `[${notification.type}] ${notification.content}`;
                    messages.appendChild(p);
                });
            }
        })
        .catch(err => {
            console.error('ì•ˆì½ì€ ì•Œë¦¼ ì¡°íšŒ ì‹¤íŒ¨:', err);
            messages.innerHTML = '<p><i>ì•Œë¦¼ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</i></p>';
        });
    }

    // SSE ì—°ê²° ë° ì‹¤ì‹œê°„ ì•Œë¦¼ ì²˜ë¦¬
    function connectSse() {
        const eventSource = new EventSource(sseUrl);

        eventSource.onopen = () => console.log('SSE ì—°ê²° ì„±ê³µ');
/*
        eventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                const p = document.createElement('p');
                p.textContent = `[${data.type}] ${data.content}`;
                messages.appendChild(p);
            } catch (e) {
                console.error('SSE ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', event.data);
            }
        };
*/
        eventSource.addEventListener("sse", function(event) {
        try {
            const data = JSON.parse(event.data);
            const p = document.createElement('p');
            p.textContent = `[${data.type}] ${data.content}`;
            messages.appendChild(p);
        } catch (e) {
            console.error('SSE(sse) ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', event.data);
        }
    });

        eventSource.onerror = function(err) {
            console.error('SSE ì—°ê²° ì˜¤ë¥˜:', err);
            eventSource.close();
            setTimeout(() => {
                console.log('SSE ì¬ì—°ê²° ì‹œë„...');
                connectSse();
            }, 5000);
        };
    }

    // ì´ˆê¸° ë¡œë”© ë° SSE ì—°ê²°
    loadUnreadNotifications();
    connectSse();
</script>

</body>
</html>
